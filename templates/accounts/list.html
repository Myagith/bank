{% extends 'base.html' %}
{% load account_filters %}
{% block title %}Gestion des Comptes{% endblock %}

{% block content %}
<div class="dashboard-header">
  <h2>ğŸ¦ Gestion des Comptes</h2>
  <a href="/accounts/create/" class="btn btn-primary">â• Nouveau Compte</a>
</div>

<!-- Statistiques -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-icon">ğŸ“Š</div>
    <div class="stat-content">
      <div class="stat-value">{{ accounts.count }}</div>
      <div class="stat-label">Total Comptes</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">âœ…</div>
    <div class="stat-content">
      <div class="stat-value">{{ open_accounts_count }}</div>
      <div class="stat-label">Comptes Ouverts</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">ğŸ’°</div>
    <div class="stat-content">
      <div class="stat-value">{{ total_balance|floatformat:2 }} â‚¬</div>
      <div class="stat-label">Solde Total</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">ğŸ‘¥</div>
    <div class="stat-content">
      <div class="stat-value">{{ unique_customers_count }}</div>
      <div class="stat-label">Clients Uniques</div>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="filters-card">
  <h3>ğŸ” Filtres</h3>
  <form method="get" class="filters-form">
    <div class="filters-grid">
      <div class="filter-group">
        <label for="bank">ğŸ¦ Banque</label>
        <select name="customer__bank__name" id="bank" class="form-select">
          <option value="">Toutes les banques</option>
          {% for bank in banks %}
            <option value="{{ bank.name }}" {% if request.GET.customer__bank__name == bank.name %}selected{% endif %}>
              {{ bank.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="status">ğŸ“‹ Statut</label>
        <select name="status" id="status" class="form-select">
          <option value="">Tous les statuts</option>
          <option value="OPEN" {% if request.GET.status == 'OPEN' %}selected{% endif %}>Ouvert</option>
          <option value="CLOSED" {% if request.GET.status == 'CLOSED' %}selected{% endif %}>FermÃ©</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="type">ğŸ’³ Type</label>
        <select name="type" id="type" class="form-select">
          <option value="">Tous les types</option>
          <option value="CHECKING" {% if request.GET.type == 'CHECKING' %}selected{% endif %}>Compte Courant</option>
          <option value="SAVINGS" {% if request.GET.type == 'SAVINGS' %}selected{% endif %}>Compte Ã‰pargne</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="country">ğŸŒ Pays</label>
        <select name="customer__bank__country" id="country" class="form-select">
          <option value="">Tous les pays</option>
          {% for country in countries %}
            <option value="{{ country }}" {% if request.GET.customer__bank__country == country %}selected{% endif %}>
              {{ country }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="city">ğŸ™ï¸ Ville</label>
        <select name="customer__bank__city" id="city" class="form-select">
          <option value="">Toutes les villes</option>
          {% for city in cities %}
            <option value="{{ city }}" {% if request.GET.customer__bank__city == city %}selected{% endif %}>
              {{ city }}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label for="customer_count">ğŸ‘¥ Nombre de Clients</label>
        <select name="customer_count" id="customer_count" class="form-select">
          <option value="">Tous</option>
          <option value="1" {% if request.GET.customer_count == '1' %}selected{% endif %}>1 client</option>
          <option value="2-5" {% if request.GET.customer_count == '2-5' %}selected{% endif %}>2-5 clients</option>
          <option value="6-10" {% if request.GET.customer_count == '6-10' %}selected{% endif %}>6-10 clients</option>
          <option value="10+" {% if request.GET.customer_count == '10+' %}selected{% endif %}>Plus de 10 clients</option>
        </select>
      </div>
    </div>
    
    <div class="filters-actions">
      <button type="submit" class="btn btn-primary">ğŸ” Filtrer</button>
      <a href="/accounts/" class="btn btn-secondary">ğŸ”„ RÃ©initialiser</a>
    </div>
  </form>
</div>

<!-- Liste des comptes -->
<div class="accounts-section">
  <div class="section-header">
    <h3>ğŸ“‹ Liste des Comptes ({{ accounts.count }})</h3>
    {% if request.GET %}
      <span class="active-filters">
        Filtres actifs: 
        {% for key, value in request.GET.items %}
          {% if value and key != 'page' %}
            <span class="filter-tag">{{ key }}: {{ value }}</span>
          {% endif %}
        {% endfor %}
      </span>
    {% endif %}
  </div>

  <div class="accounts-grid">
    {% for account in accounts %}
      <div class="account-card">
        <div class="account-header">
          <div class="account-number">{{ account.number }}</div>
          <div class="account-status">
            {% if account.status == 'OPEN' %}
              <span class="status-badge status-open">âœ… Ouvert</span>
            {% else %}
              <span class="status-badge status-closed">âŒ FermÃ©</span>
            {% endif %}
          </div>
        </div>
        
        <div class="account-info">
          <div class="info-row">
            <span class="info-label">ğŸ‘¤ Client:</span>
            <span class="info-value">{{ account.customer.name }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ğŸ¦ Banque:</span>
            <span class="info-value">{{ account.customer.bank.name }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">ğŸ’³ Type:</span>
            <span class="info-value">
              {% if account.type == 'CHECKING' %}
                <span class="type-badge type-checking">Compte Courant</span>
              {% else %}
                <span class="type-badge type-savings">Compte Ã‰pargne</span>
              {% endif %}
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">ğŸ’° Solde:</span>
            <span class="info-value balance">{{ account.balance|floatformat:2 }} â‚¬</span>
          </div>
          <div class="info-row">
            <span class="info-label">ğŸ“… Ouvert le:</span>
            <span class="info-value">{{ account.opened_at|date:"d/m/Y" }}</span>
          </div>
        </div>
        
        <div class="account-actions">
          <a href="/accounts/{{ account.pk }}/" class="btn btn-sm btn-info">ğŸ‘ï¸ DÃ©tails</a>
          <a href="/accounts/{{ account.pk }}/update/" class="btn btn-sm btn-warning">âœï¸ Modifier</a>
          {% if account.status == 'OPEN' %}
            <a href="/accounts/{{ account.pk }}/close/" class="btn btn-sm btn-danger" 
               onclick="return confirm('ÃŠtes-vous sÃ»r de vouloir fermer ce compte ?')">ğŸ”’ Fermer</a>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <h3>Aucun compte trouvÃ©</h3>
        <p>{% if request.GET %}Aucun compte ne correspond Ã  vos critÃ¨res de recherche.{% else %}Aucun compte n'a encore Ã©tÃ© crÃ©Ã©.{% endif %}</p>
        <a href="/accounts/create/" class="btn btn-primary">â• CrÃ©er le premier compte</a>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Pagination -->
{% if accounts.has_other_pages %}
  <div class="pagination">
    {% if accounts.has_previous %}
      <a href="?page={{ accounts.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-sm">â† PrÃ©cÃ©dent</a>
    {% endif %}
    
    <span class="page-info">
      Page {{ accounts.number }} sur {{ accounts.paginator.num_pages }}
    </span>
    
    {% if accounts.has_next %}
      <a href="?page={{ accounts.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-sm">Suivant â†’</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}